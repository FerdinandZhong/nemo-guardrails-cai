# NeMo Guardrails Deployment Jobs Configuration
#
# This configuration defines the job sequence for deploying NeMo Guardrails on CAI:
# 1. git_sync: Pull latest code from repository
# 2. setup_environment: Create Python venv and install NeMo Guardrails
# 3. launch_guardrails: Start the guardrails server as a CAI Application
#
# Note on Script Entry Points:
# - setup_environment uses Python directly (creates the venv)
# - launch_guardrails uses Python job entry point (which activates venv via bash wrapper)
#   This follows CAI best practices and ensures clean virtual environment activation.
# - Dependencies created in setup_environment are available to launch_guardrails via venv
#
# Job Dependencies (handled automatically by CAI):
# - git_sync (root) → setup_environment → launch_guardrails (child)
# - When root job succeeds, child jobs auto-trigger automatically
# - We only trigger the root job via trigger_jobs.py

jobs:
  # Job 1: Sync Git Repository (ROOT JOB)
  git_sync:
    name: "Git Repository Sync"
    description: "Clone or sync repository from GitHub"
    script: |
      #!/bin/bash
      set -e
      cd /home/cdsw

      # Check if repo exists
      if [ -d ".git" ]; then
        echo "Repository exists, pulling latest changes..."
        git pull origin main || git pull origin master
      else
        echo "Repository not found, should be cloned during project creation"
        exit 1
      fi

      echo "Git sync completed successfully"
    kernel: "python3"
    cpu: 2
    memory: 4
    timeout: 600
    parent_job_key: null

  # Job 2: Setup Python Environment
  setup_environment:
    name: "Setup Python Environment"
    description: "Create Python venv and install NeMo Guardrails dependencies"
    script: "python3 cai_integration/setup_environment.py"
    kernel: "python3"
    cpu: 4
    memory: 8
    timeout: 1800
    parent_job_key: "git_sync"

  # Job 3: Launch Guardrails Server (uses venv from setup_environment)
  launch_guardrails:
    name: "Launch Guardrails Server"
    description: "Deploy NeMo Guardrails as CAI Application (runs in venv via bash wrapper)"
    script: "cai_integration/launch_guardrails_job.py"
    kernel: "python3"
    cpu: 2
    memory: 4
    timeout: 900
    parent_job_key: "setup_environment"
    environment:
      CML_HOST: "${CML_HOST}"
      CML_API_KEY: "${CML_API_KEY}"
      CDSW_PROJECT_ID: "${CDSW_PROJECT_ID}"
