# NeMo Guardrails Deployment Jobs Configuration
#
# This configuration defines the job sequence for deploying NeMo Guardrails on CAI:
# 1. git_sync: Pull latest code from repository
# 2. setup_environment: Create Python venv and install NeMo Guardrails
# 3. launch_guardrails: Start the guardrails server as a CAI Application
#
# Note on Script Entry Points:
# - All scripts must be file paths relative to project root (e.g., "cai_integration/script.py")
# - CAI API does not support inline scripts or command prefixes
# - git_sync: Bash script that pulls repository
# - setup_environment: Python script that creates the venv (skips if already configured)
# - launch_guardrails: Python script that creates CAI Application via REST API
#
# Environment Variables:
# - FORCE_REINSTALL: Set to "true" to force full environment reinstall (default: "false")
#
# Job Dependencies (handled automatically by CAI):
# - setup_environment (root) â†’ launch_guardrails (child)
# - When root job succeeds, child jobs auto-trigger automatically
# - We only trigger the root job via trigger_jobs.py
#
# Note: git_sync job is optional and can be added later for updates
# Initial deployment doesn't need git_sync since setup_project.py clones the repo

jobs:
  # Job 1: Setup Python Environment (ROOT JOB for initial deployment)
  # Set FORCE_REINSTALL=true to force full reinstall even if venv exists
  setup_environment:
    name: "Setup Python Environment"
    description: "Create Python venv and install NeMo Guardrails dependencies"
    script: "cai_integration/setup_environment.py"
    kernel: "python3"
    cpu: 4
    memory: 8
    timeout: 1800
    parent_job_key: null
    runtime_identifier: "docker.repository.cloudera.com/cloudera/cdsw/ml-runtime-pbj-jupyterlab-python3.11-standard:2025.09.1-b5"
    environment:
      FORCE_REINSTALL: "false"

  # Job 2: Launch Guardrails Server (creates CAI Application)
  # Uses CAI built-in environment variables: CDSW_DOMAIN, CDSW_APIV2_KEY, CDSW_PROJECT_ID
  launch_guardrails:
    name: "Launch Guardrails Server"
    description: "Create and deploy NeMo Guardrails as CAI Application"
    script: "cai_integration/launch_guardrails.py"
    kernel: "python3"
    cpu: 2
    memory: 4
    timeout: 900
    parent_job_key: "setup_environment"
    runtime_identifier: "docker.repository.cloudera.com/cloudera/cdsw/ml-runtime-pbj-jupyterlab-python3.11-standard:2025.09.1-b5"
